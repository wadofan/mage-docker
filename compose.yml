services:
  apache:
    container_name: mage-apache
    build: ./apache
    volumes:
      - ./apache/logs:/usr/local/apache2/logs/httpd:rw
      - ./webroot:/usr/local/apache2/htdocs:ro
    networks:
      - mage
    restart: unless-stopped

  nginx:
    container_name: mage-nginx
    image: nginx
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./nginx/logs:/var/log/nginx:rw
      - ./nginx/templates:/etc/nginx/templates:ro
      - ./letsencrypt/cert:/etc/letsencrypt:ro
      - ./letsencrypt/web:/var/www/certbot:ro
    environment:
      - CERT_DOMAIN=*****
    networks:
      - mage
    restart: unless-stopped

  # start only ones to prepare a config
  certbot-generate-cert:
    image: certbot/certbot
    container_name: certbot-generate
    environment:
      - TZ=Europe/Kiev
      - DOMAIN=
      - EMAIL=
    volumes:
      - ./letsencrypt/cert:/etc/letsencrypt:rw
      - ./letsencrypt/web:/var/www/certbot:rw
    entrypoint: "/bin/sh -c 'certbot certonly --webroot -w /var/www/certbot -d $${DOMAIN} --non-interactive --agree-tos --no-eff-email --email $${EMAIL}'"

  # this container watch for cert expiry after you get a valid cert
  certbot-watch:
    container_name: certbot-watch
    image: certbot/certbot
    environment:
      - TZ=Europe/Kiev
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot; sleep 12h & wait $${!}; done;'"
    volumes:
      - ./letsencrypt/cert:/etc/letsencrypt:rw
      - ./letsencrypt/web:/var/www/certbot:rw
      # - ./letsencrypt/logs:/var/log/letsencrypt:rw
    networks:
      - mage
    depends_on:
      - nginx

networks:
  mage:
    name: mage-net
    driver: bridge
