networks:
  mage:
    name: mage-net
    driver: bridge

services:
  apache:
    container_name: mage-apache
    build: ./apache
    volumes:
      - ./apache/logs:/usr/local/apache2/logs/httpd:rw
      - ./scific:/usr/local/apache2/htdocs:ro
    networks:
      - mage
    restart: unless-stopped

  nginx:
    container_name: mage-nginx
    image: nginx
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./nginx/logs:/var/log/nginx:rw
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./letsencrypt/conf/live:/etc/nginx/cert.d:ro
      - ./letsencrypt/acme:/var/www/certbot:ro
    networks:
      - mage
    restart: unless-stopped

    certbot:
      container_name: mage-certbot
      image: certbot/certbot
      command: >
        certonly --webroot 
        --webroot-path /var/www/certbot/
        --noninteractive --agree-tos
        --email ${LETS_EMAIL} --no-eff-email
        --cert-name scific -d ${LETS_DOMAIN}
      volumes:
        - ./letsencrypt/conf:/etc/letsencrypt:rw
        - ./letsencrypt/acme:/var/www/certbot:rw
      networks:
        - mage
      depends_on: nginx
